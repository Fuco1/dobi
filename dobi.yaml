#
# dobi.yaml - task definitions for the project
#

meta:
    project: dobi
    default: all

#
# Mounts
#

mount=source:
    bind: .
    path: /go/src/github.com/dnephin/dobi

mount=dist:
    bind: ./dist/bin/
    path: /go/bin/

#
# Images
#

image=builder:
    image: dobi-dev
    context: ./dockerfiles/
    dockerfile: Dockerfile.build
    tags: ['{unique}', '{project}-{git.short-sha}', '{unique}-{git.branch}']

image=linter:
    image: dobi-linter
    dockerfile: dockerfiles/Dockerfile.lint

image=dist-img:
    image: 'dnephin/dobi'
    tags: ['{env.DOBI_VERSION}']
    dockerfile: dockerfiles/Dockerfile.dist

#
# Run
#

run=binary:
    use: builder
    artifact: ./dist/bin/dobi
    mounts: [source, dist]
    command: "./script/build"

run=watch:
    use: builder
    mounts: [source, dist]
    command: "filewatcher -x .git -x dist -x vendor -x '**/*.swp' go test -v './${dir}'"
    interactive: true

run=shell:
    use: builder
    mounts: [source, dist]
    interactive: true
    command: bash

run=test-unit:
    use: builder
    mounts: [source, dist]
    command: "bash -c 'go test -v $(glide novendor)'"

run=lint:
    use: linter
    mounts: [source]

#
# Aliases
#

alias=test:
    tasks: [test-unit]

alias=all:
    tasks: [lint, test, binary]

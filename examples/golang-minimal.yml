#
# An example configuration for a golang application.
#
# This configuration handles the common tasks required for most projects:
#   * build one or more binaries
#   * run unit tests
#   * run integration tests against a service dependency
#   * run linting and style checks
#   * build a docker image for publishing the application
#

#
# An `image` resource
#
# Produces an image with a single tag
#
builder-image:
  image: "project-dev"
  tags: ["latest"]
  dockerfile: Dockerfile.build
  context: .
  args:
    GO_VERSION: 1.5

#
# A `volume` resource for the binaries
#
dist:
  volume: "project-dist"
  type: "host"
  path: "./dist"
  container_path: "/target"

#
# A `volume` resource for the project source
#
source:
  volume: "project-src"
  type: "host"
  path: "."
  container_path: "/go/src/github.com/org/project"

#
# A `container` resource for building the binaries
#
build-binary:
  container: "project-build-binary"
  image: {resource: "builder-image"}
  artifact: "./dist/binary-name"
  depends:
    - source
    - dist

#
# An `image` resource for publishing the project as a minimal docker image
#
dist-image:
  image: "project-name"
  dockerfile: Dockerfile.run
  context: .
  tags: ["latest", "${VERSION}"]
  depends: ["build-binary"]

#
# A `container` resource for running unit tests
#
test-unit:
  container: "project-test-unit"
  image: {resource: "builder-image"}
  command: "go test -v ./..."
  depends: ["source"]


#
# A `container` resource for running end-to-end tests
#
test-acceptance:
  container: "project-test-aceptance"
  image: {resource: "builder-image"}
  commands: "tests/acceptance/run.sh"
  net: {resource: "dev-env"}
  depends:
    - source
    - dist
    - build-binary

#
# An `environment` resource for running end-to-end test
#
dev-env:
  compose_file: "docker-compose.yml"
  project_name: "test-${UNIQUE_ID}"

#
# An `image` resource for running linting and style checks
#
lint-image:
  image: "project-style"
  tags: ["latest"]
  dockerfile: Dockerfile.style
  context: .
  depends: ["project-dev"]

#
# A `container` resource
#
lint:
  container: "project-dev-lint"
  image: {resource: "project-style"}
  depends: ["source"]
